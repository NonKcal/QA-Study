name: QA Automation Pipeline

# 트리거: main 브랜치에 코드가 push 되면 실행
on:
  push:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest  # 리눅스 서버 대여

    steps:
    # 1. 내 코드 내려받기
    - uses: actions/checkout@v4

    # 2. 파이썬 설치
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3. 라이브러리 설치 (requirements.txt 이용)
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        playwright install chromium  # 브라우저 설치

    # 4. [중요] GitHub Secrets를 이용해 토큰 파일(json) 즉석 생성
    # 서버에는 json 파일이 없으므로, Secret 정보를 조합해 만들어줍니다.
    - name: Create Token JSON
      env:
        ACCESS_TOKEN: ${{ secrets.KAKAO_ACCESS_TOKEN }}
        REFRESH_TOKEN: ${{ secrets.KAKAO_REFRESH_TOKEN }}
      run: |
        echo "{\"access_token\": \"$ACCESS_TOKEN\", \"refresh_token\": \"$REFRESH_TOKEN\"}" > kakao_token.json

    # 5. 테스트 실행
    - name: Run Playwright Test
      env:
        # .env 대신 환경변수로 주입
        KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
        CI: true
      run: |
        python kakao_map.py

    # 6. (선택) 에러 스크린샷 업로드 (실패 시에만)
    - name: Upload Error Screenshot
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-screenshot
        path: error_capture.png